= Anypoint DataGraph Hosting Options and Networking

Anypoint DataGraph supports the following Anypoint Platform hosting options and network configurations.

== Anypoint Platform Control Plane Hosting Options

Anypoint DataGraph is available for US and EU clouds control plane hosting.

== Anypoint Platform Runtime Plane Hosting Options

Anypoint DataGraph must connect to the destination URL you provide when adding an API to the unified schema. You don't need to make any extra configurations on your runtime plane if you meet any of the following scenarios:

* Your API implementations run on CloudHub.
* Your API implementations run on standalone instances and are connected to an Anypoint Virtual Private Cloud (Anypoint VPC).
* Your API implementations run on any runtime plane hosting option and are public.

If your API instances run on standalone instances, are not public, and are not connected to Anypoint VPC, you must first pair your standalone runtimes to Anypoint VPC. See xref:runtime-manager::to-request-vpc-connectivity.adoc[Request Anypoint VPC Connectivity to Your Network] for more information.

== Anypoint DataGraph Architecture and Networking

Anypoint DataGraph is a fully managed service that runs on Anypoint Platform within the default region of your business group.

image::datagraph-network-architecture.png[Networking diagram for Anypoint DataGraph and Anypoint Platform]

Consumer requests from the public internet are routed to Anypoint DataGraph through shared or dedicated load balancers, depending on your CloudHub or Anypoint Virtual Private Cloud (Anypoint VPC) configuration. DataGraph sends requests to the underlying APIs that make up the unified schema. Similarly, when you make changes in the Anypoint DataGraph UI, those changes trigger updates of Anypoint DataGraph in the Runtime Plane.

If you’re unable to use port 8082 on a shared load balancer, you must xref:hosting-options.adoc#set-a-dedicated-load-balancer-url-for-anypoint-datagraph[set a new URL for Anypoint DataGraph to use on a CloudHub dedicated load balancer (DLB)].

[[set-a-dedicated-load-balancer-url-for-anypoint-datagraph]]
== Set a Dedicated Load Balancer URL for Anypoint Datagraph

If you’re unable to use Port 8082 on a CloudHub shared load balancer, you must set a URL for Anypoint DataGraph to use on a dedicated load balancer (DLB).

You set the URL using a DLB mapping rule that you add to the Anypoint DataGraph configuration.

=== Prerequisites

* You must have the xref:permissions.adoc[Admin or Operator permission] for the environment in which you want to specify a DLB URL.
* You must be able to xref:runtime-manager::anypoint-platform-cli#authentication[authenticate to] and run commands from the Anypoint CLI.
* You must be familiar with xref:runtime-manager::lb-mapping-rules[creating DLB mapping rules].
* You must xref:runtime-manager::cloudhub-dedicated-load-balancer.adoc#create-and-configure-a-dedicated-load-balancer[create and configure a DLB].

To complete this task, you:

. Use the Anypoint CLI to gather details about your DLB and Anypoint DataGraph.
. Use Anypoint Runtime Manager to create a mapping rule for the DLB.
. Use the Anypoint CLI to add the DLB configuration to Anypoint DataGraph.

=== Gather Details about the DLB and Anypoint DataGraph

. Connect to the Anypoint CLI using your Anypoint Platform username and password.
. If you did not previously set the environment, do so with the following command:
+
`use environment <environment name>`
. Get the name of the DLB:
+
`cloudhub load-balancer describe <dlb name>`
+
The expected output resembles:
+
`Name | examplelb`
+
. Get the CloudHub domain for the Anypoint DataGraph application:
+
`datagraph load-balancer-config describe`
+
The expected value resembles:
+
`Domain |  lb.anypointdns.net`
. Note the values for steps 3 and 4.

=== Create a Mapping Rule for the DLB

Based on the way DLB mapping rules work, you must configure the *Input Path* and *Output Path* so that the final DLB URL (created in Step 2 of adding the DLB configuration to Anypoint DataGraph) is able to access the endpoint of the Anypoint DataGraph application, which is  `/graphql`.

. From Anypoint Platform, select *Runtime Manager*.
. From the navigation menu, select *Load Balancers*.
. Click a load balancer name, and then click a certificate name.
+
Ensure your load balancer has a valid, CA-signed certficate, or the browser won't connect to Anypoint DataGraph. 
. In the *URL Mapping Rules* section, click *Add New Rule*.
. Complete the fields with the following values:
** *Input Path* (`inputUri`): The URI that the client requests: for example, `/{app}/`
** *Target App* (`appName`): The domain for the Anypoint DataGraph application discovered in Step 5 of the gathering details task
** *Output Path* (`appURI`): The URI string to pass to Anypoint DataGraph; for example  `/` or `/graphql`
** *Protocol* (`upstreamProtocol`): https
+
Anypoint DataGraph supports only HTTPS.

=== Add the DLB Configuration to Anypoint DataGraph

After you add the mapping rule, you configure the DLB for use with Anypoint Datagraph.

. Check the DLB URL for Anypoint DataGraph:
+
`datagraph load-balancer-config describe`
+
By default, no value is returned for `dlbUrl` if you haven’t previously configured a DLB for that Anypoint DataGraph environment.
. Add the new DLB URL:
+
`datagraph load-balancer-config add <url>`
+
Replace `<url>` with a valid URL that includes the DLB name and domain (gathered in Steps 3 and 4 of the gathering details task) and the mapping rule *Input Path*, for example,
+
....
datagraph load-balancer-config add examplelb.lb.anypointdns.net/datagraph/graphql
....
+
For example, consider the following mapping rules for `examplelb.lb.anypointdns.net` depending on the value of *Input Path*:
+
[%header%autowidth.spread]
|===
|Index |Input URI (Input Path) |App name |App URI (Output Path)
|0 |`/graphql` |`examplelb.lb.anypointdns.net` |`/graphql`
|1 |`/datagraph/` |`examplelb.lb.anypointdns.net` |`/graphql`
|2 |`/datagraph/` |`examplelb.lb.anypointdns.net` |`/`
|3 |`/{app}/` |`{app}` | `/`
|===
+
The appropriate DLB URL is:
+
* Index 0: `examplelb.lb.anypointdns.net/graphql`
* Index 1: `examplelb.lb.anypointdns.net/graphql`
* Index 2: `examplelb.lb.anypointdns.net/datagraph/graphql`
* Index 3: `examplelb.lb.anypointdns.net/datagraph/graphql`

. Validate that the value was updated:
+
`datagraph load-balancer-config describe`
+
The CLI returns details that include the application name for the Anypoint DataGraph load balancer and the full domain name for the DLB.

After you add this change, Anypoint DataGraph re-deploys, and you must wait for the status indicator to indicate that Anypoint DataGraph is up to date.

=== Remove the DLB Configuration from Anypoint DataGraph

You can remove the DLB configuration using the following command:

`datagraph load-balancer-config remove`

When you remove the configuration, Anypoint DataGraph redeploys.


== Additional Resources

* xref:general::intro-platform-hosting.adoc[Anypoint Platform Hosting Options]
